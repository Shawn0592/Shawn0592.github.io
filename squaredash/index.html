<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<meta name="viewport" content="width=device-width,user-scalable=no"/>
	<link href='https://fonts.googleapis.com/css?family=Ubuntu:700' rel='stylesheet' type='text/css'>
	<link rel="icon" href="img/favicon.ico" type="images/x-icon">
	<title>SquareDash</title>
</head>
<body>
	<script src="https://vk.com/js/api/xd_connection.js?2" type="text/javascript"></script>
	<script type="text/javascript" src="point.js"></script>
 	<script type="text/javascript">
	
 	var vk_inited = false;
 	VK.init(function() {
 		vk_inited = true;
 	}, function() {

 	}, '5.60');

 	var width = 640, height = 480;
	var js = new PointJS('2d', width, height, {backgroundColor: '#757575'});
	js.system.initFullScale();

	var game = js.game;
	var m = js.mouseControl.initMouseControl();
	var key = js.keyControl.initKeyControl();
	var point = js.vector.point;
	var brush = js.brush;
	var OOP = js.OOP;
	var math = js.math;
	var size = js.vector.size;
	var random = js.math.random;
	var rc = js.colors.randomColor;
	var log = js.system.log;
	var width = js.game.getWH().w;
	var height = js.game.getWH().h;
	var click = false;
	var recordStatus = false;
	
	var bg = [], oldB;
	OOP.forInt(3, function (i) {
		oldB = game.newImageObject({
			file : 'img/bg.png',
			h : height,
			onload : function () {
				this.x = i * this.w;
			}
		});
		bg.push(oldB);
	});

	var gr = [], oldG;
	OOP.forInt(200, function (i) {
		oldG = game.newImageObject({
			file : 'img/bg_bottom.png',
			w : width / 20,
			h : 100,
			onload : function () {
				this.x = i * this.w;
				this.y = -this.h + height;
			}
		});
		gr.push(oldG);
	});

	var gr_up = [], oldGUP;
	OOP.forInt(200, function(i) {
		oldGUP = game.newImageObject({
			file : 'img/bg_bottom.png',
			w : width / 20,
			h : 50,
			y : 0,
			onload : function () {
				this.x = i * this.w;
			}
		});
		gr_up.push(oldGUP);
	});

	var gr_bottom = [], oldGBT;
	OOP.forInt(200, function(i) {
		oldGBT = game.newImageObject({
			file : 'img/bg_bottom.png',
			w : width / 20,
			h : 50,
			onload : function () {
				this.x = i * this.w;
				this.y = -this.h + height;
			}
		});
		gr_bottom.push(oldGBT);
	});

	var drawBG = function () {
		OOP.forArr(bg, function(el) {
			el.draw();
			el.move(point(-3, 0));
			if(el.x + el.w < 0) {
				el.x = oldB.x + oldB.w;
				oldB = el;
			}
		});
	};

	var drawGR = function () {
		OOP.forArr(gr, function(el) {
			el.draw();
			el.move(point(-5.5, 0));
			if(el.x + el.w < 0) {
				el.x = oldG.x + oldG.w;
				oldG = el;
			}
			if(el.isIntersect(player)) {
				click = false;
				player.dy = -0.5;
			}
		});
	};

	var drawGUP = function () {
		OOP.forArr(gr_up, function(el) {
			el.draw();
		});
	};

	var drawGBT = function () {
		OOP.forArr(gr_bottom, function(el) {
			el.draw();
		});
	};

	var bg1 = [], oldB;
	OOP.forInt(3, function (i) {
		oldB = game.newImageObject({
			file : 'img/bg.png',
			h : height,
			onload : function () {
				this.x = i * this.w;
			}
		});
		bg.push(oldB);
	});

	var gr1 = [], oldG;
	OOP.forInt(200, function (i) {
		oldG = game.newImageObject({
			file : 'img/bg_bottom.png',
			w : width / 20,
			h : 100,
			onload : function () {
				this.x = i * this.w;
				this.y = -this.h + height;
			}
		});
		gr.push(oldG);
	});

	var drawBG1 = function () {
		OOP.forArr(bg, function(el) {
			el.draw();
		});
	};

	var drawGR1 = function () {
		OOP.forArr(gr, function(el) {
			el.draw();
		});
	};

	var logo = game.newImageObject({
		file: 'img/logo.png',
		x : 150, y : 50
	});

	var button_play = game.newImageObject({
		file: 'img/button_play.png',
		x: 250, y : 130,
		scale: 0.5
	});

	var fon_blue = game.newImageObject({
		file: 'img/bg_bottom.png',
		x: 0, y: 0,
		w : width, h : height
	});

	var button_shop = game.newImageObject({
		file: 'img/button_shop.png',
		x: 250, y: 160,
		scale: 0.5
	});

	var play = game.newTextObject({
		text: 'play',
		color: '#fef2dc',
	  	size : 15,
	  	font : 'Ubuntu'  
	});

	var shop = game.newTextObject({
		text: 'shop',
		color: '#fef2dc',
		size: 15,
	  	font : 'Ubuntu'  
	});

	var player = game.newImageObject({
		w : 34, h : 34,
		file : 'img/player.png',
		x : 100, y : 350,
		scale : 0.9,
		userData : {
			dy : 0
		}
	});

	var t11 = game.newImageObject({
		file: 'img/triangle_b.png',
		scale: 0.5,
		x : 300, y : 355,
		w : 50, h : 50
	});

	var t22 = game.newImageObject({
		file: 'img/triangle_b.png',
		scale: 0.5,
		x : 430, y : 355,
		w : 50, h : 50
	});

	var t33 = game.newImageObject({
		file: 'img/triangle_b.png',
		scale: 0.5,
		x : 455, y : 355,
		w : 50, h : 50
	});

	var t44 = game.newImageObject({
		file: 'img/triangle_t.png',
		scale: 0.5,
		x : 455, y : 270,
		w : 50, h : 50
	});

	var t55 = game.newImageObject({
		file: 'img/triangle_t.png',
		scale: 0.5,
		x : 240, y : 270,
		w : 50, h : 100
	});

	var t66 = game.newImageObject({
		file: 'img/gr_up.png',
		scale: 0.5,
		x : 555, y : 355,
		w : 50, h : 50
	});

	var t77 = game.newImageObject({
		file: 'img/gr_up.png',
		scale: 0.5,
		x : 605, y : 330,
		w : 50, h : 50
	});
	/*var oblako = game.newImageObject({
		file: 'img/oblako.png',
		//scale: 0.5,
		x : 65, y : 255
	});

	var developed = game.newTextObject({

	})*/

	var score = 0;

	var music1 = js.audio.newAudio("audio/BackOnTrack.mp3", 0.5);
	var music2 = js.audio.newAudio("audio/BaseAfterBase.mp3", 0.5);
	var music3 = js.audio.newAudio("audio/CantLetGo.mp3", 0.5);

	var money = 10;
	var record = 10;
	var addMoney = 0;
	var endScore = score - 1;

	/* 

	GR: #728ebd
	BG: #fef2dc

	*/

	var Menu = function () {
		this.update = function () {
			drawBG1();
			drawGR1();
			
			t11.draw();
			t22.draw();
			t33.draw();
			t44.draw();
			t55.draw();
			t66.draw();
			t77.draw();

			//t44.drawStaticBox();
			//oblako.draw();

			player.draw();
			player.setPositionC(point(115, 365));
			
			logo.draw();
			button_play.draw();
			button_shop.draw();

			play.setPositionS(point(283, 130));
			play.draw();

			shop.setPositionS(point(281, 160));
			shop.draw();

			if(m.isPeekObject('LEFT', play)) {
				game.setLoop('game');
			}
			if(m.isPeekObject('LEFT', shop)) {
				game.setLoop('shop');
			}
			if(key.isDown('A')) {
				if(key.isDown('S')) {
					if(key.isDown('D')) {
						if(key.isDown('5')) {
							if(key.isDown('0')) {
								game.setLoop('adminka');
							}
						}
					}						
				}
			}
			//console.log(key.getKeyList());
		};
	};

	var Game = function () {
		
		var triangles = [], oldTriangle = false;
		var space = 96;
		
		var addTriangles = function(y) {

			var dX = oldTriangle ? oldTriangle.bottom.x + random(150, 600) : width;

			var t = game.newImageObject({
				file: 'img/triangle_b.png',
				scale: 0.5,
				x : dX, y : 451 - 96,
				w : 50, h : 50,
			});

			var t2 = game.newImageObject({
				file: 'img/triangle_t.png',
				scale: 0.5,
				x : dX, y : 361 - 96,
				w: 50, h : 50,
			});

			var t3 = game.newImageObject({
				file: 'img/triangle_b.png',
				scale: 0.5,
				x : dX, y : 451 - 96,
				w : 50, h : 50,
			});

			t.setBox ({
				offset : point(9, 5), 
				size : size(-20, -20)
			});
			t2.setBox ({
				offset : point(9, 20), 
				size : size(-20, -20)
			});
			t3.setBox ({
				offset : point(9, 5), 
				size : size(-20, -20)
			});
			/*var t2 = game.newImageObject({
				file: 'img/triangle_b2.png',
				scale: 0.5,
				x : dX, y : 0,
				w : 100, h : 50,
				onload : function () {
					this.y = 452 - space;
				}
			});*/

			var obj = {
				'bottom' : t,
				'top' : t2,
				'triangle' : t3,
			}

			oldTriangle = obj;
			triangles.push(obj);
		};

		var drawTriangles = function () {
			OOP.forArr(triangles, function(el) {
				el.bottom.draw();
				el.top.draw();
				el.triangle.draw();

				el.bottom.move(point(-5.5, 0));
				el.top.move(point(-5.5, 0));
				el.triangle.move(point(-5.5, 0));

				if(el.top.x + el.top.y < 0) {
					el.top.x = el.bottom.x = oldTriangle.top.x + oldTriangle.bottom.w + random(150, 600);
					//el.triangle.x = oldTriangle.triangle.x + oldTriangle.triangle.w + 400;
					oldTriangle = el;
				};

				if(el.triangle.x < 0) {
					el.triangle.x = oldTriangle.triangle.x + oldTriangle.triangle.w + random(300, 600);
				};

				if(el.bottom.isInCamera()) {
					if(el.bottom.isIntersect(player)) {
						game.setLoop('over');												
					}
				};
				if(el.top.isInCamera()) {
					if(el.top.isIntersect(player)) {
						game.setLoop('over');
					}
				};
				if(el.triangle.isInCamera()) {
					if(el.triangle.isIntersect(player)) {
						game.setLoop('over');
					}
				};
			});
		};

		this.update = function () {
			drawBG();
			
			brush.drawRect({
				fillColor : '#9aa498',
				h : 30, w : 70,
				x : 560, y : 10
			});

			brush.drawText({
				text : ' ' + score,
				size : 20,
				color: '#fef2dc',
				x : 565, y: 10,
				font: 'Ubuntu'
			});	

			var pause = game.newImageObject({
				file: 'img/pause.png',
				x : 10, y : 10,
				scale: 0.5
			});
			pause.draw();

			player.draw();
			player.dy += 0.5;
			player.y += player.dy;

			drawGR();
			drawTriangles();

			score = score +1;

			if(player.y >= player.dy)
				player.dy == 0;

			if(m.isPeekObject('LEFT', pause)) {
				this.entry;
				game.setLoop('menu');
			}

			if(m.isPress('LEFT')) {
				if(click == false) {
					click = true;
					player.dy = -8;
					player.angle = player.angle + 90;
				}
			}
			if(key.isPress('SPACE')) {
				if(click == false) {
					click = true;
					player.dy = -8;
					player.angle = player.angle + 90;
				}
			}
		};
		this.entry = function () {
			triangles = [], oldTriangle = false;

			OOP.forInt(5, function() {
				addTriangles(height / 2);
			});

			player.setPositionC(point(115, 365));//385
			score = 0;
		};
	};

	var Over = function () {
		this.update = function () {
			var fon_zad = game.newRectObject({
				x: 150, y: 100,
				w: 300, h: 150,
				fillColor: '#728ebd'
			});
			var fon_zad_bl = game.newRectObject({
				x: 0, y: 0,
				w: width, h: height,
				fillColor: '#fef2dc'
			});
			var gameover = game.newTextObject({
				text: 'Game Over',
				font: 'Ubuntu',
				size: 25,
				color: '#fef2dc',
				x: 230, y: 110
			});
			var scoreT = game.newTextObject({
				text: 'Score: ' + score,
				font: 'Ubuntu',
				size: 25,
				color: '#fef2dc',
				x: 220, y: 140				
			});
			var back_menu = game.newImageObject({
				file: 'img/back.png',
				x: 270, y: 195
			});
			var reflesh = game.newImageObject({
				file: 'img/reload.png',
				x: 300, y: 195
			});
			fon_zad_bl.draw();
			fon_zad.draw();	
			gameover.draw();
			scoreT.draw();
			back_menu.draw();
			reflesh.draw();
			var share = game.newTextObject({
				text: 'Поделится счетом',
				font: 'Arial',
				size: 15,
				color: '#fef2dc',
				style: 'Bold',
				x: 230, y: 225
			});
			share.draw();
			if(m.isPeekObject('LEFT', back_menu)) {
				player.angle = 0;
				game.setLoop('menu');
			}
			if(m.isPeekObject('LEFT', reflesh)) {
				player.angle = 0;
				game.setLoop('game');
			}
			if(m.isPeekObject('LEFT', share)) {
				VK.api('wall.post', {
					'message': 'В новой игре SquareDash я набрал ' + score + ' очков, а сколько наберешь ты?\n\nИгра - https://vk.com/app5715796\nГруппа игры - https://vk.com/squaredash',
					'attachments': 'photo-132547045_456239018'
				}, function (data) {
					log('susses');
				});
			}
		};
	};

	var Shop = function() {
		this.update = function() {
			drawBG();
			drawGUP();
			drawGBT();
			var shopT = game.newTextObject({
				text: 'Shop',
				x: 290, y: 10,
				font: 'Ubuntu',
				size: 20,
				color: '#fef2dc'
			});
			var back = game.newImageObject({
				file: 'img/back.png',
				x: 10, y: 10				
			});
			var coins_banner = game.newImageObject({
				file: 'img/coins_banner.png',
				x: 76, y: 71,
				scale: 0.4
			});
			var coins1_banner = game.newImageObject({
				file: 'img/coins_banner.png',
				x: 76, y: 71+coins_banner.h+10,
				scale: 0.4
			});
			var skins_banner = game.newImageObject({
				file: 'img/skins_banner.png',
				x: 325, y: 71,
				scale: 0.4
			});
			var skins1_banner = game.newImageObject({
				file: 'img/skins_banner.png',
				x: 325, y: 71+skins_banner.h+10,
				scale: 0.4
			});
			var avatar = game.newImageObject({
				file: 'img/dmitry.png',
				x: 295, y: 410
			});
			var balance = game.newTextObject({
				text: '' + money,
				x: 275, y: 460,
				font: 'Ubuntu',
				size: 15,
				color: '#fef2dc'
			});



			shopT.draw();
			back.draw();
			coins_banner.draw();
			skins_banner.draw();
			coins1_banner.draw();
			skins1_banner.draw();
			avatar.draw();
			balance.draw();



			if(m.isPeekObject('LEFT', back)) {
				game.setLoop('menu');
			}
		};
	};

	var Adminka = function() {
		this.update = function() {
			drawBG();
			drawGBT();
			drawGUP();
			brush.drawText({
				text: 'Admin Panel',
				color: '#fef2dc',
				size: 20,
				x : 260, y : 10,
				font: 'Ubuntu'
			});
			var dmitry = game.newImageObject({
				file: 'img/dmitry.png',
				w: 30, h: 30,
				x: 480, y: 10 
			});
			var jenya = game.newImageObject({
				file: 'img/jenya.png',
				w: 30, h: 30,
				x: 520, y: 10 
			});
			var egor = game.newImageObject({
				file: 'img/egor.png',
				w: 30, h: 30,
				x: 560, y: 10 
			});
			var denis = game.newImageObject({
				file: 'img/denis.png',
				w: 30, h: 30,
				x: 600, y: 10 
			});
			var logoSD = game.newImageObject({
				file: 'img/logo.png',
				scale: 0.5,
				x : 440, y : 50
			});
			var logoPL = game.newImageObject({
				file: 'img/150x150.jpg',
				x : 480, y: 100,
				scale: 0.5
			});
			var button1_green = game.newImageObject({
				file: 'img/button_play.png',
				x: 15, y : 65,
				scale: 0.5
			});
			var button1_yellow = game.newImageObject({
				file: 'img/button_shop.png',
				x: 15, y : 105,
				scale: 0.5
			});
			var button2_green = game.newImageObject({
				file: 'img/button_play.png',
				x: 15, y : 145,
				scale: 0.5
			});
			var button2_yellow = game.newImageObject({
				file: 'img/button_shop.png',
				x: 15, y : 185,
				scale: 0.5
			});
			jenya.draw();
			egor.draw();
			denis.draw();
			dmitry.draw();
			logoSD.draw();
			logoPL.draw();
			button1_green.draw();
			button1_yellow.draw();
			button2_green.draw();
			button2_yellow.draw();
			brush.drawText({
				text: 'Online: 1',
				color: '#fef2dc',
			  	size : 15,
			  	font : 'Ubuntu',
			  	x: 30, y: 65  
			});
			brush.drawText({
				text: '+100SD',
				color: '#fef2dc',
			  	size : 15,
			  	font : 'Ubuntu',
			  	x: 30, y: 105  
			});
			brush.drawText({
				text: '+1000SD',
				color: '#fef2dc',
			  	size : 15,
			  	font : 'Ubuntu',
			  	x: 30, y: 145  
			});
			brush.drawText({
				text: '+10000SD',
				color: '#fef2dc',
			  	size : 15,
			  	font : 'Ubuntu',
			  	x: 30, y: 185  
			});
			var back = game.newImageObject({
				file: 'img/back.png',
				x: 10, y: 10				
			});
			back.draw();
			if(m.isPeekObject('LEFT', back)) {
				game.setLoop('menu');
			}
		};
	}

	game.newLoopFromClassObject('game', new Game());
	game.newLoopFromClassObject('menu', new Menu());
	game.newLoopFromClassObject('over', new Over());
	game.newLoopFromClassObject('shop', new Shop());
	game.newLoopFromClassObject('adminka', new Adminka());
	game.setLoopSound('game', [music1, music2, music3]);
	/* 

	GR: #728ebd
	BG: #fef2dc

	*/
	game.startLoop('menu');
	</script>
</body>
</html>
